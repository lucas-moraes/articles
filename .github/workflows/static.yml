name: Minify and Deploy to GitHub Pages

on:
  push:
    branches: ["main"]
  workflow_dispatch:

permissions:
  contents: write
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # Instalar minificadores
      - name: Install minifiers (CSS + JS)
        run: |
          sudo npm install -g css-minify terser

      # Criar pasta final
      - name: Create dist folder
        run: mkdir dist

      # Copiar todos os arquivos para dist
      - name: Copy all project files
        run: |
         shopt -s dotglob
         for item in *; do
          if [ "$item" != "dist" ]; then
            cp -R "$item" dist/
          fi
         done

      - name: Minify CSS and create .min.css
        run: |
          if [ -d "dist/css" ]; then
            for file in dist/css/*.css; do
              css-minify -f "$file" -o dist/css
              rm "$file"
            done
          fi

      # Minificar JS (se existir)
      - name: Minify JS files and create .min.js
        run: |
          # 1. Verifica se a pasta dist/js existe
          if [ -d "dist/js" ]; then
            echo "Minifying JavaScript files in dist/js..."
            
            # 2. Itera sobre cada arquivo .js
            for original_file in dist/js/*.js; do
              # Verifica se o arquivo é válido (importante se não houver .js na pasta)
              if [ -f "$original_file" ]; then
                 w
                # 3. CRIA O NOME DO ARQUIVO DE SAÍDA .min.js
                # Usa substituição de string: substitui '.js' no final por '.min.js'
                output_file="${original_file/.js/.min.js}"
                
                echo "Processing: $original_file -> $output_file"
                
                # 4. EXECUTA O TERSER
                # -o: define o novo nome do arquivo (.min.js)
                terser "$original_file" -c -m -o "$output_file"
                
                # 5. REMOVE O ARQUIVO ORIGINAL SOMENTE SE O TERSER FOI BEM-SUCEDIDO
                if [ $? -eq 0 ]; then
                  rm "$original_file"
                  echo "Original file removed: $original_file"
                else
                  echo "❌ Error minifying $original_file. Original file kept."
                  exit 1 # Força a falha do passo no CI/CD se a minificação falhar
                fi
              fi
            done
          else
            echo "dist/js folder not found. Skipping minification."
          fi

      - name: Update index.html references
        run: |
          if [ -f dist/index.html ]; then
            # CSS
            sed -i 's|css/\(.*\).css|css/\1.min.css|g' dist/index.html
            # JS
            sed -i 's|js/\(.*\).js|js/\1.min.js|g' dist/index.html
          fi

      # Subir artefato
      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: dist

  deploy:
    runs-on: ubuntu-latest
    needs: build
    environment:
      name: github-pages

    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
