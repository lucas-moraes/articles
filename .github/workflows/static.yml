name: Minify and Deploy to GitHub Pages

on:
  push:
    branches: ["main"]
  workflow_dispatch:

permissions:
  contents: write
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # Instalar minificadores
      - name: Install minifiers (CSS + JS)
        run: |
          sudo npm install -g css-minify terser

      # Criar pasta final
      - name: Create dist folder
        run: mkdir dist

      # Copiar todos os arquivos para dist
      - name: Copy all project files
        run: |
         shopt -s dotglob
         for item in *; do
          if [ "$item" != "dist" ]; then
            cp -R "$item" dist/
          fi
         done

      - name: Minify CSS and create .min.css
        run: |
          if [ -d "dist/css" ]; then
            for file in dist/css/*.css; do
              css-minify -f "$file" -o dist/css
              rm "$file"
            done
          fi

      # Minificar JS (se existir)
      - name: Minify JS files in dist/js
        run: |
          # 1. Verifica se a pasta dist/js existe e contém arquivos .js
          if [ -d "dist/js" ]; then
            echo "Minifying JavaScript files in dist/js..."
            
            # 2. Itera sobre todos os arquivos .js dentro da pasta dist/js
            # Usamos find para garantir que o loop funcione corretamente.
            find dist/js -maxdepth 1 -name "*.js" | while read original_file; do
              if [ -f "$original_file" ]; then
                
                # 3. Define o caminho de saída (.min.js)
                # Sintaxe robusta para substituir a extensão '.js' por '.min.js'
                output_file="${original_file/.js/.min.js}"
                
                echo "Processing: $original_file -> $output_file"
                  
                # 4. EXECUTA O TERSER
                terser "$original_file" -c -m -o "$output_file"
                  
                if [ $? -eq 0 ]; then
                  # 5. REMOVE O ARQUIVO ORIGINAL
                  rm "$original_file"
                  echo "Original file removed: $original_file"
                else
                  echo "❌ Error minifying $original_file."
                  exit 1 # Força a falha
                fi
              fi
            done
            echo "Minification step complete."
          else
            echo "A pasta dist/js não existe. Pulando minificação JS."
          fi

      - name: Update index.html references
        run: |
          if [ -f dist/index.html ]; then
            # 1. Ajustar referências CSS (Se houver)
            sed -i 's|css/\(.*\).css|css/\1.min.css|g' dist/index.html
            
            # 2. AJUSTE JS: Troca todas as referências src="./nome.js" por src="./nome.min.js"
            # O ponto (.) é importante para referências relativas
            sed -i 's|\.\/\(.*\).js|\.\/\1.min.js|g' dist/index.html
            echo "index.html references updated to use .min.js"
          fi

      - name: Criar 404.html para Fallback da SPA
        run: |
          # Este 404.html garante que qualquer URL que o servidor não encontrar (ex: /articles/1)
          # seja redirecionada para a raiz, onde o seu roteador SPA assume o controle.
          echo '<!DOCTYPE html><html><head><meta charset="UTF-8"><script>' > dist/404.html
          echo 'var path = window.location.pathname;' >> dist/404.html
          echo 'sessionStorage.setItem("redirect", path);' >> dist/404.html
          echo 'window.location.replace("/");' >> dist/404.html
          echo '</script></head><body>Redirecionando...</body></html>' >> dist/404.html
          echo "Arquivo 404.html criado na pasta dist para Fallback da SPA."

      # Subir artefato
      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: dist

  deploy:
    runs-on: ubuntu-latest
    needs: build
    environment:
      name: github-pages

    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
